name: Build and Push to ECR

on:
  push:
    branches: [ "main" ]
# k8s 폴더만 수정했을 땐(무한루프 방지) 빌드 돌지 않게 제외
    paths-ignore:
      - 'k8s/**'

permissions:
  id-token: write
  contents: write # Git에 다시 커밋할 수 있는 권한 부여

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: streamer
        # [핵심] latest 대신 깃허브 커밋 해시(SHA)를 태그로 사용
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

    - name: Update Kubernetes Manifest
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: streamer
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # k8s/deployment.yaml 파일에서 image: 부분을 찾아서 새 태그로 바꿔치기
        sed -i "s|image: .*amazonaws.com/.*|image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|" k8s/deployment.yaml
        
        # 바뀐 내용을 Git에 저장
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add k8s/deployment.yaml
        # [skip ci]를 붙여야 무한 루프(커밋 -> 빌드 -> 커밋 -> 빌드)를 방지함
        git commit -m "Update image tag to $IMAGE_TAG [skip ci]"
        git push